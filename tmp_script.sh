#!/bin/sh

set -eux
cd "$(dirname $0)"

function build_rust() {
    cd discovery_engine_core
    cargo check --quiet 2>/dev/null
    cargo build
    cd ..
}

function test_rust() {
    cd discovery_engine_core

    cargo +nightly fmt --all -- --check
    cargo sort --grouped --workspace --check

    # Workaround for code-gen bug
    cargo check --quiet 2>/dev/null || :

    cargo clippy --all-targets

    cargo test

    cd ..
}

function build_bindgen() {
    build_rust

    cd discovery_engine_flutter
    flutter pub get
    flutter run ffigen --config ffigen.yaml
    cd ..

    cd discovery_engine_core
    # this won't work
    cargo run -p async-bindgen-gen-dart -- \
        --ffi-class ./include/XaynDiscoveryEngineBindings.h \
        --genesis ../discovery_engine_flutter/lib/src/genesis.ffigen.dart
    cd ..

    # ios needs the original headers, as wee need to statically link in the
    # binary code generated by rust (instead of loading it as a shared library)
    cp ./discovery_engine_core/include/*.h ./discovery_engine_flutter/ios/Classes/
}

CMD="$1"
shift
"$CMD" "$@"

